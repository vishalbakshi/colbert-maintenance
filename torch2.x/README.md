## `main.py`

This file contains code to _generate_ different artifacts of interest.

-   `_index`: Generates a PLAID index folder at `f"{MOUNT}/{project}/{date}-{source}-{nranks}/indexing/{dataset_name}"`
-   `_search`: Generates search rankings TSV at `f"{MOUNT}/{project}/{date}-{source}-{nranks}/search/{dataset_name}.tsv"`
-   `_train`: Trains on `NRANKS` GPUs using data at `f"{MOUNT}/data`
-   `_bert`: Generates and stores outputs from and related to the `BertModel`.
-   `_layer_norm`: Compares `nn.LayerNorm` outputs for different batch sizes.
-   `_amp_bert`: Generates outputs from mixed precision forward pass of `BertModel`.
-   `_remove_dense`: Replaces `layer.intermediate.dense` with `Identity` to assess it's impact on model outputs.
-   `_norm`: Generates and stores full and mixed precision tensors before/after using `nn.functional.normalize`
-   `_lse`: Stands for `local_sample_embs`. Encodes different batches of `sample_pids`.
-   `_sort`: Generates pre-sort and sorted tensors (to mimic `centroids.pt`).
-   `_subtract`: Generates the difference between two tensors (to mimic `residuals.pt`).
-   `_swap_search`: Searches (and stores rankings.tsv) on a given index path. 

## `compare.py`

This file contains code to _compare_ different artifacts located at different paths.

## Comparing PyTorch Increasing Versions

### Indexing Results

|Version A|Version B|Index `.pt` Shapes Match?|Index `.pt` Values Match?|
|:-:|:-:|:-:|:-:|
|1.13.1|2.0.1|Yes|Yes|
|<mark>2.0.1</mark>|<mark>2.1</mark>|<mark>No</mark>|<mark>No</mark>|
|2.1|2.2|Yes|Yes|
|2.1|2.2|Yes|Yes|
|2.2|2.3|Yes|Yes|
|2.3|2.4|Yes|Yes|
|<mark>2.4</mark>|<mark>2.5</mark>|<mark>No</mark>|<mark>No</mark>|
|2.5|2.6|Yes|Yes|
|2.6|2.7|Yes|Yes|
|<mark>2.7</mark>|<mark>2.8</mark>|<mark>No</mark>|<mark>No</mark>|

### Search Results

The following results are for search on the index generated by the same PyTorch version (e.g. search the `torch==2.4.1` index with a `torch==2.4.1` `colbert-ai` install).

|PyTorch Version A|PyTorch Version B|Recall@10 Change|MRR@10 Change|Avg # of Diff PIDs Retreived|Query-Level Recall@10 Changes|Query-Level MRR@10 Changes|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|1.13.1|2.0.0|--|--|--|--|--
|2.0.0|2.0.1|--|--|--|--|--
|2.0.1|2.1.0|<mark style="background-color: lightgreen;">+0.001</mark>|<mark style="background-color: lightgreen;">+0.005</mark>|1.23|Equal: 268<br><mark style="background-color: lightgreen;">Increase: 2</mark><br><mark style="background-color: lightpink;">Decrease: 1</mark>|Equal: 254<br><mark style="background-color: lightgreen;">Increase: 11</mark><br><mark style="background-color: lightpink;">Decrease: 6</mark>|
|2.1.0|2.1.1|--|--|--|--|--
|2.1.1|2.1.2|--|--|--|--|--
|2.1.2|2.2.0|--|--|--|--|--
|2.2.0|2.2.1|--|--|--|--|--
|2.2.1|2.2.2|--|--|--|--|--
|2.2.2|2.3.0|--|--|--|--|--
|2.3.0|2.3.1|--|--|--|--|--
|2.3.1|2.4.0|--|--|--|--|--
|2.4.0|2.4.1|--|--|--|--|--
|2.4.1|2.5.0|<mark style="background-color: lightpink;">-0.004</mark>|<mark style="background-color: lightpink;">-0.002</mark>|1.08|Equal: 268<br><mark style="background-color: lightpink;">Decrease: 3</mark>|Equal: 251<br><mark style="background-color: lightpink;">Decrease:12</mark><br><mark style="background-color: lightgreen;">Increase: 8</mark>
|2.5.0|2.5.1|--|--|--|--|--
|2.5.1|2.6.0|--|--|--|--|--
|2.6.0|2.7.0|--|--|--|--|--
|2.7.0|2.7.1|--|--|--|--|--
|2.7.1|2.8.0|--|--|--|--|--

What happens if we search with the next PyTorch version but using _the previous PyTorch version's index_? The purpose of doing this is to isolate discrepancies in search results that are due to `colbert-ai` search code changes due to the PyTorch version upgrade _independent of index differences_. 

|PyTorch Version A|PyTorch Version B|Recall@10 Change|MRR@10 Change|Avg # of Diff PIDs Retreived|Query-Level Recall@10 Changes|Query-Level MRR@10 Changes|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|2.0.1|2.1.0|--|<mark style="background-color: lightgreen;">-4.1e-5</mark>|0.16|Equal: 271|Equal: 270<br><mark style="background-color: lightpink;">Decrease: 1</mark>|
|2.4.1|2.5.0|--|<mark style="background-color: lightpink;">-0.002</mark>|0.17|Equal: 271|Equal: 269<br><mark style="background-color: lightpink;">Decrease:1</mark><br><mark style="background-color: lightgreen;">Increase: 1</mark>
